name: Publish Preview to GitHub Packages

on:
  push:
    branches: [ dev ]

permissions:
  contents: read
  packages: write

jobs:
  publish-preview:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v2
      with:
        bun-version: latest

    - name: Get version from package.json
      id: version
      run: |
        VERSION=$(bun -e "console.log((await Bun.file('package.json').json()).version)")
        PREVIEW_VERSION="${VERSION}-dev.${GITHUB_SHA:0:7}"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "preview_version=$PREVIEW_VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        echo "Preview Version: $PREVIEW_VERSION"

    - name: Install dependencies
      run: bun install

    - name: Build packages
      run: bash build.sh

    - name: Configure npm for GitHub Packages
      run: |
        echo "@apophis-sdk:registry=https://npm.pkg.github.com" >> ~/.npmrc

    - name: Publish preview packages to GitHub Packages
      env:
        NPM_CONFIG_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        for package in packages/*; do
          if [ -d "$package" ] && [ -f "$package/package.json" ]; then
            PACKAGE_NAME=$(basename $package)
            echo "ðŸš€ Publishing preview of $PACKAGE_NAME to GitHub Packages"
            cd "$package"

            # Update version to preview version
            bun -e "
              const pkg = await Bun.file('package.json').json();
              pkg.version = '${{ steps.version.outputs.preview_version }}';
              await Bun.write('package.json', JSON.stringify(pkg, null, 2) + '\n');
            "

            # Publish to GitHub Packages
            bun publish --access public --registry https://npm.pkg.github.com
            cd - > /dev/null
          fi
        done
